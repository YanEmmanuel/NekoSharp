name: Release NekoSharp

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: 10.0.x
  SOLUTION_FILE: NekoSharp.sln
  APP_PROJECT: NekoSharp.App/NekoSharp.App.csproj
  CONFIGURATION: Release

jobs:
  verify:
    name: Verify (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj
            Directory.Packages.props
            global.json
            NuGet.config

      - name: Restore (solution)
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: >
          dotnet build ${{ env.SOLUTION_FILE }}
          --configuration ${{ env.CONFIGURATION }}
          --no-restore
          -p:ContinuousIntegrationBuild=true

      - name: Test
        run: >
          dotnet test ${{ env.SOLUTION_FILE }}
          --configuration ${{ env.CONFIGURATION }}
          --no-build
          --verbosity normal

  build-windows:
    name: Build Windows (portable GTK)
    needs: verify
    runs-on: windows-latest
    timeout-minutes: 45

    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj
            Directory.Packages.props
            global.json
            NuGet.config

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gtk4
            mingw-w64-ucrt-x86_64-libadwaita

      - name: Restore (win-x64)
        run: dotnet restore ${{ env.APP_PROJECT }} -r win-x64 -p:PublishReadyToRun=true

      - name: Publish (win-x64)
        run: |
          $publishDir = "out/win-x64"
          dotnet publish ${{ env.APP_PROJECT }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime win-x64 `
            --self-contained true `
            --no-restore `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:PublishReadyToRun=true `
            -p:ContinuousIntegrationBuild=true `
            -o $publishDir

      - name: Prepare portable package
        run: |
          $ErrorActionPreference = "Stop"
          $tag = "${{ github.ref_name }}"
          $publishDir = "out/win-x64"
          $pkgRoot = "package/NekoSharp-$tag-win-x64-portable-gtk"
          $gtkRoot = "C:\msys64\ucrt64"

          New-Item -ItemType Directory -Force -Path $pkgRoot | Out-Null
          New-Item -ItemType Directory -Force -Path "$pkgRoot\gtk" | Out-Null

          Copy-Item "$publishDir\*" $pkgRoot -Recurse -Force

          $exe = Get-ChildItem -Path $publishDir -Filter *.exe -File | Select-Object -First 1
          if (-not $exe) { throw "No .exe found" }

          function Copy-IfExists {
            param([string]$Source,[string]$Dest)
            if (Test-Path $Source) {
              New-Item -ItemType Directory -Force -Path (Split-Path $Dest -Parent) | Out-Null
              Copy-Item $Source $Dest -Recurse -Force
            }
          }

          Copy-IfExists "$gtkRoot\bin" "$pkgRoot\gtk\bin"
          Copy-IfExists "$gtkRoot\etc\gtk-4.0" "$pkgRoot\gtk\etc\gtk-4.0"
          Copy-IfExists "$gtkRoot\etc\fonts" "$pkgRoot\gtk\etc\fonts"
          Copy-IfExists "$gtkRoot\lib\gdk-pixbuf-2.0" "$pkgRoot\gtk\lib\gdk-pixbuf-2.0"
          Copy-IfExists "$gtkRoot\lib\gio" "$pkgRoot\gtk\lib\gio"
          Copy-IfExists "$gtkRoot\lib\gtk-4.0" "$pkgRoot\gtk\lib\gtk-4.0"
          Copy-IfExists "$gtkRoot\share\glib-2.0" "$pkgRoot\gtk\share\glib-2.0"
          Copy-IfExists "$gtkRoot\share\icons" "$pkgRoot\gtk\share\icons"
          Copy-IfExists "$gtkRoot\share\themes" "$pkgRoot\gtk\share\themes"
          Copy-IfExists "$gtkRoot\share\locale" "$pkgRoot\gtk\share\locale"
          Copy-IfExists "$gtkRoot\share\libadwaita-1" "$pkgRoot\gtk\share\libadwaita-1"

          $glibCompileSchemas = "$gtkRoot\bin\glib-compile-schemas.exe"
          $schemaDir = "$pkgRoot\gtk\share\glib-2.0\schemas"
          if ((Test-Path $glibCompileSchemas) -and (Test-Path $schemaDir)) {
            & $glibCompileSchemas $schemaDir
            if ($LASTEXITCODE -ne 0) { throw "glib-compile-schemas failed" }
          }

          $cmdPath = Join-Path $pkgRoot "Run-NekoSharp.cmd"
          @"
          @echo off
          setlocal
          set "APPDIR=%~dp0"
          set "GTKDIR=%APPDIR%gtk"
          set "PATH=%GTKDIR%\bin;%PATH%"
          set "XDG_DATA_DIRS=%GTKDIR%\share"
          set "GSETTINGS_SCHEMA_DIR=%GTKDIR%\share\glib-2.0\schemas"
          set "GTK_DATA_PREFIX=%GTKDIR%"
          set "GIO_MODULE_DIR=%GTKDIR%\lib\gio\modules"
          set "GDK_PIXBUF_MODULEDIR=%GTKDIR%\lib\gdk-pixbuf-2.0\2.10.0\loaders"
          if exist "%GTKDIR%\bin\gdk-pixbuf-query-loaders.exe" (
            "%GTKDIR%\bin\gdk-pixbuf-query-loaders.exe" > "%GDK_PIXBUF_MODULEDIR%\loaders.cache" 2>nul
            if exist "%GDK_PIXBUF_MODULEDIR%\loaders.cache" (
              set "GDK_PIXBUF_MODULE_FILE=%GDK_PIXBUF_MODULEDIR%\loaders.cache"
            )
          )
          start "" "%APPDIR%$($exe.Name)"
          exit /b %errorlevel%
          "@ | Set-Content -Path $cmdPath -Encoding ascii

      - name: Create zip + sha256
        run: |
          $ErrorActionPreference = "Stop"
          $tag = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $zipPath = "dist/NekoSharp-$tag-win-x64-portable-gtk.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "package/NekoSharp-$tag-win-x64-portable-gtk\*" -DestinationPath $zipPath -Force
          $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower()
          "$hash  $(Split-Path $zipPath -Leaf)" | Set-Content -Path "dist/SHA256SUMS-win-x64.txt" -Encoding utf8

      - uses: actions/upload-artifact@v4
        with:
          name: release-win-x64
          path: dist/*
          if-no-files-found: error
          retention-days: 1

  build-linux:
    name: Build Linux
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj
            Directory.Packages.props
            global.json
            NuGet.config

      - name: Restore (linux-x64)
        run: dotnet restore ${{ env.APP_PROJECT }} -r linux-x64

      - name: Publish (linux-x64)
        run: |
          dotnet publish ${{ env.APP_PROJECT }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime linux-x64 `
            --self-contained true `
            --no-restore `
            -p:PublishSingleFile=true `
            -p:ContinuousIntegrationBuild=true `
            -o out/linux-x64

      - name: Validate publish output (linux)
        run: |
          $publishDir = "out/linux-x64"
          if (-not (Test-Path $publishDir)) { throw "Publish dir not found: $publishDir" }

          $expectedBin = [System.IO.Path]::GetFileNameWithoutExtension($env:APP_PROJECT)
          $expectedBinPath = Join-Path $publishDir $expectedBin
          $bin = if (Test-Path $expectedBinPath -PathType Leaf) { Get-Item $expectedBinPath } else { $null }

          if (-not $bin) {
            $bin = Get-ChildItem -Path $publishDir -File |
              Where-Object { $_.Name -notmatch '\.(dll|json|pdb|xml|so|a|dylib)$' } |
              Sort-Object Name |
              Select-Object -First 1
          }

          if (-not $bin) { throw "No Linux executable found in $publishDir" }

          "APP_BIN_NAME=$($bin.Name)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "App binary: $($bin.Name) (expected: $expectedBin)"

      - name: Create Linux launcher (.sh)
        run: |
          $publishDir = "out/linux-x64"
          $launcherPath = Join-Path $publishDir "Run-NekoSharp.sh"

          $launcher = @(
            '#!/usr/bin/env bash',
            'set -euo pipefail',
            'APPDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"',
            'exec "$APPDIR/__APP_BIN__" "$@"'
          ) -join "`n"
          $launcher = $launcher.Replace("__APP_BIN__", $env:APP_BIN_NAME)

          $launcher | Set-Content -Path $launcherPath -Encoding ascii
          chmod +x $launcherPath
          chmod +x (Join-Path $publishDir $env:APP_BIN_NAME)

      - name: Create tar.gz + sha256
        run: |
          $tag = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          tar -C out/linux-x64 -czf "dist/NekoSharp-$tag-linux-x64.tar.gz" .
          $file = Get-Item "dist/NekoSharp-$tag-linux-x64.tar.gz"
          $hash = (Get-FileHash -Path $file.FullName -Algorithm SHA256).Hash.ToLower()
          "$hash  $($file.Name)" | Set-Content -Path "dist/SHA256SUMS-linux-x64.txt" -Encoding utf8

      - uses: actions/upload-artifact@v4
        with:
          name: release-linux-x64
          path: dist/*
          if-no-files-found: error
          retention-days: 1

  release:
    name: Publish GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/release-win-x64/*
            artifacts/release-linux-x64/*
